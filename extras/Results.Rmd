---
params:
    save: NULL #"first.Rda"
    load: "first.Rda"
    completeReload: false
# bibliography: CohortDefinition.bib
# csl: nature-publishing-group-vancouver.csl
output:
  pdf_document:
    keep_tex: true
    md_extensions: +raw_attribute
    latex_engine: xelatex
mainfont: Arial
    #citation_package: natbib
    #rticles::sim_article
fontsize: 10pt
geometry: margin=1in
classoption: doublespace, table
longtable: true
header-includes:
  - \usepackage[numbers,sort&compress]{natbib}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{caption}
  - \usepackage{rotating}
  - \usepackage{multirow}
  - \usepackage{mwe,tikz}
  - \usepackage[percent]{overpic}
  - \usepackage{enumitem}
  - \usepackage{mas_fun}
  - \usepackage{hyperref}
---
 
\pagenumbering{gobble} <!-- Remove pagenumbering -->

```{r, echo=FALSE, warning=FALSE, message=FALSE}
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)
knitr::knit_hooks$set(document = function(x) {sub('\\usepackage[]{color}', '\\usepackage[table]{xcolor}', x, fixed = TRUE)})
library(dplyr)
library(tidyr)
library(xtable)

readRdsCamelCase <- function(file) {
  result <- readRDS(file)
  colnames(result) <- SqlRender::snakeCaseToCamelCase(colnames(result))
  return(result)
}
```

\centerline{{\Huge Results: Incidence}}

<!-- \captionsetup[table]{name=Supplementary Table} -->
<!-- \captionsetup[figure]{name=Supplementary Figure} -->
\captionsetup{labelfont=bf}

# Cohorts

```{r, echo=FALSE}
cohorts <- read.csv(file = system.file("settings", "CohortsToCreate.csv", package = "Covid19SusceptibilityAlphaBlockers")) %>% select(cohortId, shinyName)

alphaBlockerId <- cohorts %>% filter(shinyName == "Alpha-1 blocker") %>% select(cohortId) %>% pull()
fiveAlphaId <- cohorts %>% filter(shinyName == "5ARI / PDE5") %>% select(cohortId) %>% pull()

covidDiagnosisId <- cohorts %>% filter(shinyName == "Diagnosis") %>% select(cohortId) %>% pull()
hospitalizationId <- cohorts %>% filter(shinyName == "Hospitalization") %>% select(cohortId) %>% pull()
intensiveServiceId <- cohorts %>% filter(shinyName == "Intensive services") %>% select(cohortId) %>% pull()

prettyNames <- data.frame(
  cohortId = c(alphaBlockerId, fiveAlphaId),
  cohortName = c("Alpha-1 blocker", "5ARI / PDE5"))

analysisIdToKeep <- c(5, 6)
primaryAnalysisId <- 5 # Full stratified PS
```


# Sample sizes

```{r, echo=FALSE, warning=FALSE, message=FALSE}

studyFolder <- "/Users/aki-nishimura/Dropbox/Documents_Academic/Covid19AlphaBlocker"
databaseIds <- c("SIDIAP", "VA-OMOP", "CUIMC", "IQVIA_OpenClaims", "Optum_DOD", "Optum_EHR_COVID")
databaseIdLabels <- c("SIDIAP", "VA", "CUIMC", "OpenClaims", "Optum DOD", "Optum EHR", "Meta-analysis")
names(databaseIdLabels) <- c(databaseIds, "Meta-analysis")
dataDirs <- sapply(databaseIds, function (databaseId) file.path(studyFolder, databaseId))

makeSampleSizeTable <- function(databaseId, 
                                dataFolder,
                                primaryOutcomeId,
                                databaseOrder = 1) {
  cmResults <- readRDS(file = file.path(dataFolder, paste0("cohort_method_result_", databaseId, ".rds")))
  colnames(cmResults) <- SqlRender::snakeCaseToCamelCase(colnames(cmResults))
  alpha <- 0.05
  power <- 0.8
  z1MinAlpha <- qnorm(1 - alpha/2)
  zBeta <- -qnorm(1 - power)
  pA <- cmResults$targetSubjects/(cmResults$targetSubjects + cmResults$comparatorSubjects)
  pB <- 1 - pA
  totalEvents <- abs(cmResults$targetOutcomes) + (cmResults$comparatorOutcomes)
  cmResults$mdrr <- exp(sqrt((zBeta + z1MinAlpha)^2/(totalEvents * pA * pB)))
  cmResults$targetYears <- cmResults$targetDays/365.25
  cmResults$comparatorYears <- cmResults$comparatorDays/365.25
  
  cmResults <- cmResults %>% filter(analysisId %in% analysisIdToKeep, outcomeId == primaryOutcomeId)
  
  table <- rbind(
    cmResults %>% filter(targetId == alphaBlockerId, comparatorId == fiveAlphaId) %>% mutate(targetId = "Alpha-1 blocker", comparatorId = "5ARI / PDE5", order = 1)
  ) %>% mutate (databaseId = databaseId, databaseOrder = databaseOrder) %>% 
    select(targetId, comparatorId, databaseId, targetSubjects, comparatorSubjects, targetYears, comparatorYears, targetOutcomes, comparatorOutcomes, mdrr, order, databaseOrder, analysisId)
  
  table$targetSubjects <- formatC(table$targetSubjects, big.mark = ",", format = "d")
  table$comparatorSubjects <- formatC(table$comparatorSubjects, big.mark = ",", format = "d")
  table$targetYears <- formatC(table$targetYears, big.mark = ",", format = "d")
  table$comparatorYears <- formatC(table$comparatorYears, big.mark = ",", format = "d")
  table$targetOutcomes <- formatC(table$targetOutcomes, big.mark = ",", format = "d")
  table$comparatorOutcomes <- formatC(table$comparatorOutcomes, big.mark = ",", format = "d")
  # table$targetIr <- sprintf("%.2f", table$targetIr)
  # table$comparatorIr <- sprintf("%.2f", table$comparatorIr)
  table$mdrr <- sprintf("%.2f", table$mdrr)
  table$targetSubjects <- gsub("^-", "<", table$targetSubjects)
  table$comparatorSubjects <- gsub("^-", "<", table$comparatorSubjects)
  table$targetOutcomes <- gsub("^-", "<", table$targetOutcomes)
  table$comparatorOutcomes <- gsub("^-", "<", table$comparatorOutcomes)
  # table$targetIr <- gsub("^-", "<", table$targetIr)
  # table$comparatorIr <- gsub("^-", "<", table$comparatorIr)
  table$databaseId <- databaseIdLabels[[databaseId]]
  return(table)
}


tables <- lapply(
  1:length(databaseIds),
  function (i) makeSampleSizeTable(
    databaseId = databaseIds[i], 
    dataFolder = file.path(dataDirs[i], "shinyData"), 
    primaryOutcomeId = covidDiagnosisId,
    databaseOrder = i
  ) 
)
names(tables) <- databaseIds
table <- bind_rows(tables) %>% arrange(order, databaseOrder) %>% 
  mutate(targetId = "", comparatorId = "") %>% select(-order, -databaseOrder)
```

Total number of target and comparator subjects.
```{r, echo=FALSE}
# Count number of subjects

analysisId <- 6
nTargetSubjects <- sapply(
  table %>% filter(analysisId == analysisId) %>% select(targetSubjects), 
  function (x) as.numeric(gsub(",", "", x))
)

nComparatorSubjects <- sapply(
  table %>% filter(analysisId == analysisId) %>% select(comparatorSubjects), 
  function (x) as.numeric(gsub(",", "", x))
)

print(sprintf("Target: %d, Comparator: %d", sum(nTargetSubjects), sum(nComparatorSubjects)))
```

```{r, echo=FALSE, warning=FALSE}
# Add columns of hospitalization and intensive services event numbers

# First make tables for hospitalization and intensive services
hospitalizationTables <- lapply(
  1:length(databaseIds),
  function (i) makeSampleSizeTable(
    databaseId = databaseIds[i], 
    dataFolder = file.path(dataDirs[i], "shinyData"), 
    primaryOutcomeId = hospitalizationId,
    databaseOrder = i
  ) 
)
names(hospitalizationTables) <- databaseIds
hospitalizationTable <- bind_rows(hospitalizationTables) %>% arrange(order, databaseOrder) %>% 
  mutate(targetId = "", comparatorId = "") %>% select(-order, -databaseOrder)

intensiveServiceTables <- lapply(
  1:length(databaseIds),
  function (i) makeSampleSizeTable(
    databaseId = databaseIds[i], 
    dataFolder = file.path(dataDirs[i], "shinyData"), 
    primaryOutcomeId = intensiveServiceId,
    databaseOrder = i
  ) 
)
names(intensiveServiceTables) <- databaseIds
intensiveServiceTable <- bind_rows(intensiveServiceTables) %>% arrange(order, databaseOrder) %>% 
  mutate(targetId = "", comparatorId = "") %>% select(-order, -databaseOrder)

# Add columns
table_to_print <- table %>% select(-targetId, -comparatorId)
table_to_print <- table_to_print %>% mutate(
  targetHospitalization = hospitalizationTable$targetOutcomes, 
  comparatorHospitalization = hospitalizationTable$comparatorOutcomes,
  .before=mdrr
)
table_to_print <- table_to_print %>% mutate(
  targetIntensiveService = intensiveServiceTable$targetOutcomes, 
  comparatorIntensiveService = intensiveServiceTable$comparatorOutcomes,
  .before=mdrr
)

table_to_print <- bind_rows(
    table_to_print %>% filter(analysisId == 5), 
    table_to_print %>% filter(analysisId == 6)
  ) %>% select(-analysisId)
```

% Table begins: population_size_exposure_time_stratified_analysis_table

\makeatletter
\@ifundefined{c@rownum}{%
  \let\c@rownum\rownum
}{}
\@ifundefined{therownum}{%
  \def\therownum{\@arabic\rownum}%
}{}
\makeatother

\begin{table}[H]
 \caption{Population size, total exposure time and COVID-19 diagnoses for Alpha-1 blocker and 5ARI / PDE5 user target (T) and comparator (C) cohorts.}
  \rowcolors{2}{gray!6}{white}
  \centering{
  \begin{tabular}{p{.5em}rrrrrrrrrrrr}
    \hiderowcolors
    \toprule
    & & \multicolumn{2}{c}{Patients} & \multicolumn{2}{c}{Time (years)} & \multicolumn{2}{c}{Diagnosis} & \multicolumn{2}{c}{Hospital} & \multicolumn{2}{c}{Intensive} \\
    \cmidrule(lr){2-3} \cmidrule(lr){4-5} \cmidrule(lr){6-7} \cmidrule(lr){8-9} \cmidrule(lr){10-11}
    &
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C}
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C}
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C} 
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C} 
    & \multicolumn{1}{c}{T} & \multicolumn{1}{c}{C} 
    & MDRR \\
    \midrule \showrowcolors
```{r, echo=FALSE, results="asis"}

print(xtable(
        table_to_print %>% mutate(empty="", .before=databaseId), 
        format = "latex"
      ),
      include.rownames = FALSE,
      include.colnames = FALSE,
      hline.after = NULL,
      only.contents = TRUE,
      add.to.row = list(
        pos = as.list(c(0, length(databaseIds))),
        command = c("& \\multicolumn{10}{l}{\\hspace{-1.5em} Stratified analysis} \\\\",
                    "\\hiderowcolors
                    \\addtocounter{rownum}{1} 
                    \\rule{0pt}{12pt}
                    & \\multicolumn{10}{l}{\\hspace{-1.5em} Matched analysis} \\\\ \\showrowcolors") 
      ),
      sanitize.text.function = identity)
```
  \bottomrule
  \end{tabular}
  }
\end{table}   
% Table ends

